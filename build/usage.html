<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Installation/Usage &mdash; msm_we 0.1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="TODOs" href="code_todos.html" />
    <link rel="prev" title="msm_we.utils" href="stubs/msm_we.utils.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> msm_we
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme.html">msm_we</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Installation/Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#model-building-and-preparation">Model building and preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#analysis">Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#streaming">Streaming</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parallelism">Parallelism</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="code_todos.html">TODOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">msm_we</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Installation/Usage</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/usage.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="installation-usage">
<h1>Installation/Usage<a class="headerlink" href="#installation-usage" title="Permalink to this headline"></a></h1>
<p>To install <code class="code docutils literal notranslate"><span class="pre">msm_we</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> &lt;/path/to/msm_we&gt;

conda env create -f environment.yml
conda activate hamsm_env
pip install .
</pre></div>
</div>
<p>To use <code class="code docutils literal notranslate"><span class="pre">msm_we</span></code> in a project:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">msm_we</span> <span class="kn">import</span> <span class="n">msm_we</span>
</pre></div>
</div>
<p>The basic workflow of this module is as follows.</p>
<section id="model-building-and-preparation">
<h2>Model building and preparation<a class="headerlink" href="#model-building-and-preparation" title="Permalink to this headline"></a></h2>
<ol class="arabic">
<li><p>Run a weighted ensemble simulation, and produce a <code class="code docutils literal notranslate"><span class="pre">west.h5</span></code> file.</p></li>
<li><p>Augment <code class="code docutils literal notranslate"><span class="pre">west.h5</span></code> with the full coordinate information in each <code class="code docutils literal notranslate"><span class="pre">&lt;iterXXX/auxdata/coord&gt;</span></code>.</p>
<blockquote>
<div><p><code class="code docutils literal notranslate"><span class="pre">msm_we/scripts/collectCoordinates/collectCoordinates.py</span></code> has an example of this.
This functionality will likely eventually be rolled into the main package.</p>
</div></blockquote>
</li>
<li><p>Define the <code class="code docutils literal notranslate"><span class="pre">processCoordinates(self,</span> <span class="pre">coords)</span></code> function and monkey-patch it in.</p>
<blockquote>
<div><p>This function is responsible for featurization. It should take in an array of all coordinates,
and produce an array of feature-coordinates.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># A trivial example processCoordinates</span>
<span class="k">def</span> <span class="nf">processCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
    <span class="c1"># Do some stuff in here</span>
    <span class="c1"># This is NOT a complete example!</span>
    <span class="k">return</span> <span class="n">coords</span>

<span class="c1"># Monkey-patch, i.e. replace the placeholder processCoordinates</span>
<span class="c1">#   in msm_we.modelWE with your function</span>
<span class="n">msm_we</span><span class="o">.</span><span class="n">modelWE</span><span class="o">.</span><span class="n">processCoordinates</span> <span class="o">=</span> <span class="n">processCoordinates</span>
</pre></div>
</div>
<p>It’s important to do this monkey-patching at the module level, i.e. on <code class="code docutils literal notranslate"><span class="pre">msm_we.modelWE</span></code>, rather
than on an instance of a <code class="code docutils literal notranslate"><span class="pre">msm_we.modelWE</span></code> object.</p>
</div></blockquote>
</li>
<li><p>Create the model object.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">msm_we</span><span class="o">.</span><span class="n">modelWE</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Initialize the model.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">file_paths</span><span class="p">,</span> <span class="n">reference_structure_file</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span>
                <span class="n">basis_pcoord_bounds</span><span class="p">,</span> <span class="n">target_pcoord_bounds</span><span class="p">,</span>
                <span class="n">dim_reduce_method</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">pcoord_ndim</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">file_paths</span></code> is a list of paths to your WESTPA h5 files.</p>
<p><code class="code docutils literal notranslate"><span class="pre">reference_structure_file</span></code> is a file containing a topology describing your system.</p>
<p><code class="code docutils literal notranslate"><span class="pre">model_name</span></code> is what it sounds like, and is used to label various output files.</p>
<p><code class="code docutils literal notranslate"><span class="pre">basis_pcoord1_bounds</span></code> is a list of [[pcoord0 lower bound, pcoord1 upper bound],
[pcoord1 lower bound, pcoord1 upper bound], …] in pcoord-space for the basis state</p>
<p><code class="code docutils literal notranslate"><span class="pre">target_pcoord1_bounds</span></code> is a list of [[pcoord0 lower bound, pcoord1 upper bound],
[pcoord1 lower bound, pcoord1 upper bound], …] in pcoord-space for the target state</p>
<p><code class="code docutils literal notranslate"><span class="pre">dim_reduce_method</span></code> is the dimensionality reduction method (“pca”, “vamp”, or “none”)</p>
<p><code class="code docutils literal notranslate"><span class="pre">tau</span></code> is the resampling time, or the length of one WE iteration in physical units.</p>
<p><code class="code docutils literal notranslate"><span class="pre">pcoord_ndim</span></code> is the dimensionality of the progress coordinate.</p>
</div></blockquote>
</li>
<li><p>Load all coords and pcoords up to the last iteration you want to use for analysis with</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">get_iterations</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">get_coordSet</span><span class="p">(</span><span class="n">last_iter</span><span class="p">,</span> <span class="n">streaming</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="code docutils literal notranslate"><span class="pre">last_iter</span></code> is the number of iterations you have (AKA, the last iteration it’ll load data from)
and <code class="code docutils literal notranslate"><span class="pre">streaming</span></code> enables streaming data processing, which allows large datasets to fit in memory at the cost of
a (nominally) small performance hit.</p>
</div></blockquote>
</li>
<li><p>Prepare dimensionality reduction transformer by running</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">dimReduce</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Do clustering with</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">cluster_coordinates</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">streaming</span><span class="p">,</span>
    <span class="n">first_cluster_iter</span><span class="p">,</span> <span class="n">use_ray</span><span class="p">,</span> <span class="n">stratified</span><span class="p">,</span>
    <span class="o">**</span><span class="n">_cluster_args</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">n_clusters</span></code> is the total number of clusters if <code class="code docutils literal notranslate"><span class="pre">stratified=False</span></code>, or the number of clusters per bin if <code class="code docutils literal notranslate"><span class="pre">stratified=True</span></code>.</p>
<p><code class="code docutils literal notranslate"><span class="pre">streaming</span></code> is whether or not to stream over the data.</p>
<p><code class="code docutils literal notranslate"><span class="pre">first_cluster_iter</span></code> is the first iteration used for building the cluster centers (which may be desirable to exclude
initial burn-in iterations).</p>
<p><code class="code docutils literal notranslate"><span class="pre">use_ray</span></code> enables parallelization with the Ray work manager. If enabled, a Ray cluster must be initialized by
the user <em>before calling this</em>.</p>
<p><code class="code docutils literal notranslate"><span class="pre">stratified</span></code> enables stratified clustering instead of aggregate clustering. In stratified clustering,
clustering is done independently within each WE bin. This is strongly recommended to ensure your clusters provide a
good fine-grained description of your system.</p>
<p><strong>Note</strong>: At time of writing, stratified clustering implies <code class="code docutils literal notranslate"><span class="pre">streaming=True,</span> <span class="pre">use_ray=True</span></code> and will enable this
with a warning if they are not set.</p>
<p>Any additional keyword arguments will be provided directly to the clustering function through <code class="code docutils literal notranslate"><span class="pre">**_cluster_args</span></code>.</p>
</div></blockquote>
</li>
<li><p>Create the flux matrix with</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">get_fluxMatrix</span><span class="p">(</span><span class="n">lag</span><span class="p">,</span> <span class="n">first_iter</span><span class="p">,</span> <span class="n">last_iter</span><span class="p">,</span> <span class="n">use_ray</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">lag</span></code> is the lag-time used for model-building. Currently, only 0 is supported, which corresponds to looking at
transitions from each parent segment directly to its child.</p>
<p><code class="code docutils literal notranslate"><span class="pre">first_iter</span></code>, and <code class="code docutils literal notranslate"><span class="pre">last_iter</span></code> are the first and last iteration to use when computing the flux matrix.
Note that excluding many iterations may result in limited connectivity of the flux matrix, as early events may have
provided critical transitions between WE bins that may not be otherwise sampled.</p>
<p><code class="code docutils literal notranslate"><span class="pre">use_ray</span></code> enables parallelization with the Ray work manager. If enabled, a Ray cluster must be initialized by
the user <em>before calling this</em>.</p>
<ol class="loweralpha simple">
<li><p>Clean disconnected states and sort the flux matrix with</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">organize_fluxMatrix</span><span class="p">(</span><span class="n">use_ray</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">use_ray</span></code> enables parallelization with the Ray work manager. If enabled, a Ray cluster must be initialized by
the user <em>before calling this</em>.</p>
</div></blockquote>
</li>
</ol>
</section>
<section id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Permalink to this headline"></a></h2>
<ol class="arabic" start="10">
<li><p>Normalize the flux matrix to produce a transition matrix with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">get_Tmatrix</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Obtain steady-state distribution with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">get_steady_state</span><span class="p">()</span>
</pre></div>
</div>
<p>Note: This may fail or encounter difficulties for datasets where no target flux has been obtained.
This can happen with either incomplete sampling to your target state, or with equilibrium data.
This is because it uses the flux estimate as a convergence criterion.
If the flux is 0, then it’s not meaningful to  look at convergence of 0, so it’ll just run
for the maximum number of iterations. You can specify <code class="code docutils literal notranslate"><span class="pre">max_iters=1</span></code> to avoid unnecessary
iteration, or you can use <code class="code docutils literal notranslate"><span class="pre">model.get_steady_state_algebraic</span></code>.</p>
</li>
<li><p>Update cluster structures</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">update_cluster_structures</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Obtain steady-state target flux with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">get_steady_state_target_flux</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="streaming">
<h2>Streaming<a class="headerlink" href="#streaming" title="Permalink to this headline"></a></h2>
<p><code class="code docutils literal notranslate"><span class="pre">msm_we</span></code> supports streaming dimensionality reduction and clustering when dimensionality reduction is
done through PCA or not done.</p>
<p>Streaming dimensionality reduction is automatically done for PCA.</p>
<p>To use streaming clustering, pass <code class="code docutils literal notranslate"><span class="pre">streaming=True</span></code> to <code class="code docutils literal notranslate"><span class="pre">cluster_coordinates()</span></code>.</p>
<p>Streaming is not supported for VAMP, because I don’t know of a streaming implementation of VAMP dimensionality reduction.</p>
</section>
<section id="parallelism">
<h2>Parallelism<a class="headerlink" href="#parallelism" title="Permalink to this headline"></a></h2>
<p><code class="code docutils literal notranslate"><span class="pre">msm_we</span></code> supports parallelism of many “slow” parts of model-building – namely, clustering, discretization, and
flux matrix calculations. This is done through the Ray work manager.</p>
<p>Before invoking any function with <code class="code docutils literal notranslate"><span class="pre">use_ray=True</span></code>, a Ray work manager must be initialized on the machine running
the analysis. In the simplest case, this can just be</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">msm_we</span></code> will connect to whatever Ray instance is running on the machine the analysis is being performed on.
However, this can be used on a cluster to initialize a Ray cluster with workers on a number of nodes, and the <code class="code docutils literal notranslate"><span class="pre">msm_we</span></code>
running on the same node as the Ray head.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="stubs/msm_we.utils.html" class="btn btn-neutral float-left" title="msm_we.utils" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="code_todos.html" class="btn btn-neutral float-right" title="TODOs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, John Russo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>