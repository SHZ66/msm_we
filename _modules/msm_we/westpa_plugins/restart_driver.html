<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>msm_we.westpa_plugins.restart_driver &mdash; msm_we 0.1.4 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> msm_we
          </a>
              <div class="version">
                0.1.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">msm_we</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Installation/Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code_todos.html">TODOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history.html">History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">msm_we</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>msm_we.westpa_plugins.restart_driver</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for msm_we.westpa_plugins.restart_driver</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">westpa</span>
<span class="kn">from</span> <span class="nn">westpa.cli.core</span> <span class="kn">import</span> <span class="n">w_init</span>
<span class="kn">from</span> <span class="nn">westpa.cli.core</span> <span class="kn">import</span> <span class="n">w_run</span>
<span class="kn">from</span> <span class="nn">westpa.core.extloader</span> <span class="kn">import</span> <span class="n">get_object</span>
<span class="kn">from</span> <span class="nn">westpa.core.segment</span> <span class="kn">import</span> <span class="n">Segment</span>
<span class="kn">from</span> <span class="nn">westpa</span> <span class="kn">import</span> <span class="n">analysis</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">msm_we.westpa_plugins.hamsm_driver</span> <span class="kn">import</span> <span class="n">HAMSMDriver</span>

<span class="kn">import</span> <span class="nn">tqdm</span>

<span class="kn">import</span> <span class="nn">mdtraj</span> <span class="k">as</span> <span class="nn">md</span>
<span class="kn">from</span> <span class="nn">rich.logging</span> <span class="kn">import</span> <span class="n">RichHandler</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">EPS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">RichHandler</span><span class="p">())</span>

<span class="n">msm_we_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;msm_we.msm_we&quot;</span><span class="p">)</span>
<span class="n">msm_we_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>

<span class="c1"># Map structure types to extensions.</span>
<span class="c1"># This tells the plugin what extension to put on generated start-state files.</span>
<span class="n">STRUCT_EXTENSIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">md</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">PDBTrajectoryFile</span><span class="p">:</span> <span class="s2">&quot;pdb&quot;</span><span class="p">,</span>
    <span class="n">md</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">AmberRestartFile</span><span class="p">:</span> <span class="s2">&quot;rst7&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">EXTENSION_LOCKFILE</span> <span class="o">=</span> <span class="s2">&quot;doing_extension&quot;</span>


<span class="k">def</span> <span class="nf">check_target_reached</span><span class="p">(</span><span class="n">h5_filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the target state was reached, given the data in a WEST H5 file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    h5_filename: string</span>
<span class="sd">        Path to a WESTPA HDF5 data file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">h5_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5_file</span><span class="p">:</span>
        <span class="c1"># Get the key to the final iteration. Need to do -2 instead of -1 because there&#39;s an empty-ish final iteration</span>
        <span class="c1">#   written.</span>
        <span class="k">for</span> <span class="n">iteration_key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">h5_file</span><span class="p">[</span><span class="s2">&quot;iterations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">endpoint_types</span> <span class="o">=</span> <span class="n">h5_file</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;iterations/</span><span class="si">{</span><span class="n">iteration_key</span><span class="si">}</span><span class="s2">/seg_index&quot;</span><span class="p">][</span>
                <span class="s2">&quot;endpoint_type&quot;</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">Segment</span><span class="o">.</span><span class="n">SEG_ENDPOINT_RECYCLED</span> <span class="ow">in</span> <span class="n">endpoint_types</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;recycled segment found in file </span><span class="si">{</span><span class="n">h5_filename</span><span class="si">}</span><span class="s2"> at iteration </span><span class="si">{</span><span class="n">iteration_key</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">fix_deprecated_initialization</span><span class="p">(</span><span class="n">initialization_state</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    I changed my initialization JSON schema to use underscores instead of hyphens so I can directly expand it into</span>
<span class="sd">    keywords arguments to w_init. This just handles any old-style JSON files I still had, so they don&#39;t choke and die.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting processing, dict is now </span><span class="si">{</span><span class="n">initialization_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Some of my initial files had this old-style formatting. Handle it for now, but remove eventually</span>
    <span class="k">for</span> <span class="n">old_key</span><span class="p">,</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;tstate-file&quot;</span><span class="p">,</span> <span class="s2">&quot;tstate_file&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;bstate-file&quot;</span><span class="p">,</span> <span class="s2">&quot;bstate_file&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;sstate-file&quot;</span><span class="p">,</span> <span class="s2">&quot;sstate_file&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;segs-per-state&quot;</span><span class="p">,</span> <span class="s2">&quot;segs_per_state&quot;</span><span class="p">),</span>
    <span class="p">]:</span>
        <span class="k">if</span> <span class="n">old_key</span> <span class="ow">in</span> <span class="n">initialization_state</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;This initialization JSON file uses the deprecated  &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;hyphenated form for  </span><span class="si">{</span><span class="n">old_key</span><span class="si">}</span><span class="s2">. Replace with underscores.&quot;</span>
            <span class="p">)</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">initialization_state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_key</span><span class="p">)</span>
            <span class="n">initialization_state</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished processing, dict is now </span><span class="si">{</span><span class="n">initialization_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">initialization_state</span>


<div class="viewcode-block" id="RestartDriver"><a class="viewcode-back" href="../../../api.html#msm_we.westpa_plugins.restart_driver.RestartDriver">[docs]</a><span class="k">class</span> <span class="nc">RestartDriver</span><span class="p">(</span><span class="n">HAMSMDriver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    WESTPA plugin to automatically handle estimating steady-state from a WE run, re-initializing a new WE run in that</span>
<span class="sd">    steady-state, and then running that initialized WE run.</span>

<span class="sd">    Data from the previous run will be stored in the restart&lt;restart_number&gt;/ subdirectory of $WEST_SIM_ROOT.</span>

<span class="sd">    This plugin depends on having the start-states implementation in the main WESTPA code, which allows initializing</span>
<span class="sd">    a WE run using states that are NOT later used for recycling.</span>

<span class="sd">    These are used so that when the new WE run is initialized, initial structure selection is chosen by w_init, using</span>
<span class="sd">    weights assigned to the start-states based on MSM bin weight and WE segment weight.</span>

<span class="sd">    Since it closes out the current WE run and starts a new one, this plugin should run LAST, after all other plugins.</span>


<span class="sd">    Can be used by including the following entries in your west.cfg::</span>

<span class="sd">        west:</span>
<span class="sd">            plugins:</span>
<span class="sd">            # - plugin: An augmentation plugin is also required, such as</span>
<span class="sd">            #           msm_we.westpa_plugins.augmentation_driver.MDAugmentationDriver</span>
<span class="sd">            - plugin: msm_we.westpa_plugins.restart_driver.RestartDriver</span>
<span class="sd">                  n_restarts: Number of total restarts to do</span>
<span class="sd">                  extension_iters: Amount of iterations to extend runs by if no runs have reached the target by the</span>
<span class="sd">                    first restart.</span>
<span class="sd">                  n_runs: Number of runs to do between restarts</span>
<span class="sd">                  n_restarts_to_use: Number of restarts to use. Can be a fraction, to use the last fraction amount, or</span>
<span class="sd">                    a negative integer, to use the last N.</span>
<span class="sd">                  initialization_file: restart_initialization.json</span>
<span class="sd">                  model_name: Name for the model</span>
<span class="sd">                  n_clusters: Number of clusters to place in each WE bin (see stratified clustering for more details)</span>
<span class="sd">                  basis_pcoord_bounds: [[pcoord dim 0 lower bound, upper bound], [pcoord dim 1 lower, upper], ...]</span>
<span class="sd">                  target_pcoord_bounds: [[pcoord dim 0 lower bound, upper bound], [pcoord dim 1 lower, upper], ...]</span>
<span class="sd">                  dim_reduce_method: A string specifying a dimensionality reduction method for</span>
<span class="sd">                    :meth:`msm_we.msm_we.modelWE.dimReduce`</span>
<span class="sd">                  featurization: A python module implementing a featurization</span>
<span class="sd">                    for msm_we.msm_we.modelWE.processCoordinates</span>
<span class="sd">                  n_cpus: Number of CPUs to use with Ray</span>

<span class="sd">    TODO</span>
<span class="sd">    ----</span>
<span class="sd">    The multi-simulation management functionality of this plugin should really be broken out into a separate,</span>
<span class="sd">    multi_sim_manager plugin.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_manager</span><span class="p">,</span> <span class="n">plugin_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the RestartDriver plugin.</span>

<span class="sd">        Pulls the data_manager and sim_manager from the WESTPA run that just completed, along with</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Use the</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sim_manager</span><span class="p">,</span> <span class="n">plugin_config</span><span class="p">)</span>
        <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">_callback_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">_callback_table</span><span class="p">[</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">finalize_run</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;construct_hamsm&quot;</span><span class="p">,</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">construct_hamsm</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span><span class="s2">&quot;Restart plugin initialized&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sim_manager</span><span class="o">.</span><span class="n">work_manager</span><span class="o">.</span><span class="n">is_master</span><span class="p">:</span>
            <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span><span class="s2">&quot;Reweighting not master, skipping&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span> <span class="o">=</span> <span class="n">sim_manager</span><span class="o">.</span><span class="n">data_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_manager</span> <span class="o">=</span> <span class="n">sim_manager</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plugin_config</span> <span class="o">=</span> <span class="n">plugin_config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span> <span class="o">=</span> <span class="n">plugin_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restart_file&quot;</span><span class="p">,</span> <span class="s2">&quot;restart.dat&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialization_file</span> <span class="o">=</span> <span class="n">plugin_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;initialization_file&quot;</span><span class="p">,</span> <span class="s2">&quot;restart_initialization.json&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extension_iters</span> <span class="o">=</span> <span class="n">plugin_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extension_iters&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_total_iterations</span> <span class="o">=</span> <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;west&quot;</span><span class="p">,</span> <span class="s2">&quot;propagation&quot;</span><span class="p">,</span> <span class="s2">&quot;max_total_iterations&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_total_iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_total_iterations</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_restarts</span> <span class="o">=</span> <span class="n">plugin_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_restarts&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span> <span class="o">=</span> <span class="n">plugin_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_runs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># May want to be able to disable this, if it causes issues with recalculating new pcoords</span>
        <span class="c1">#   (i.e. during optimization)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_pcoords</span> <span class="o">=</span> <span class="n">plugin_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_pcoords&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># .get() might return this as a bool anyways, but be safe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">plugin_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>
            <span class="n">msm_we_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>

        <span class="c1"># Default to using all restarts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restarts_to_use</span> <span class="o">=</span> <span class="n">plugin_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_restarts_to_use&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_restarts</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restarts_to_use</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">restarts_to_use</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">),</span> <span class="s2">&quot;Invalid number of restarts to use&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restarts_to_use</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restarts_to_use</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">restarts_to_use</span> <span class="o">//</span> <span class="mi">1</span>
            <span class="p">),</span> <span class="s2">&quot;If choosing a decimal restarts_to_use, must be between 0 and 1.&quot;</span>

        <span class="n">struct_filetype</span> <span class="o">=</span> <span class="n">plugin_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;struct_filetype&quot;</span><span class="p">,</span> <span class="s2">&quot;mdtraj.formats.PDBTrajectoryFile&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_filetype</span> <span class="o">=</span> <span class="n">get_object</span><span class="p">(</span><span class="n">struct_filetype</span><span class="p">)</span>

        <span class="c1"># This should be low priority, because it closes the H5 file and starts a new WE run. So it should run LAST</span>
        <span class="c1">#   after any other plugins.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">plugin_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;priority&quot;</span><span class="p">,</span> <span class="mi">100</span>
        <span class="p">)</span>  <span class="c1"># I think a big number is lower priority...</span>

        <span class="c1"># If it&#39;s being used with SynD, the full coordinates must be specified for start-state generation.</span>
        <span class="c1"># TODO: Find a more efficient way to do this than explicitly constructing the inverse dictionary.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synd_full_coord_map_path</span> <span class="o">=</span> <span class="n">plugin_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;synd_full_coord_map_path&quot;</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synd_full_coord_map_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synd_full_coord_map_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">synd_full_coord_map</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

        <span class="n">sim_manager</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span>
            <span class="n">sim_manager</span><span class="o">.</span><span class="n">finalize_run</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_new_we</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pcoord_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="RestartDriver.get_original_bins"><a class="viewcode-back" href="../../../api.html#msm_we.westpa_plugins.restart_driver.RestartDriver.get_original_bins">[docs]</a>    <span class="k">def</span> <span class="nf">get_original_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtains the WE bins and their probabilities at the end of the previous iteration.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bins : np.ndarray</span>
<span class="sd">            Array of WE bins</span>

<span class="sd">        binprobs: np.ndarray</span>
<span class="sd">            WE bin weights</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">we_driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">we_driver</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">we_driver</span><span class="o">.</span><span class="n">next_iter_binning</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">binprobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">),</span> <span class="n">bins</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">n_bins</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">bins</span><span class="p">,</span> <span class="n">binprobs</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cur_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current WE iteration.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int: The current iteration. Subtract one, because in finalize_run the iter has been incremented</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_last_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get whether this is, or is past, the last iteration in this WE run.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool: Whether the current iteration is the final iteration</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">final_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">max_total_iterations</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_iter</span> <span class="o">&gt;=</span> <span class="n">final_iter</span>

<div class="viewcode-block" id="RestartDriver.prepare_extension_run"><a class="viewcode-back" href="../../../api.html#msm_we.westpa_plugins.restart_driver.RestartDriver.prepare_extension_run">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_extension_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_number</span><span class="p">,</span> <span class="n">restart_state</span><span class="p">,</span> <span class="n">first_extension</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy the necessary files for an extension run  (versus initializing a fresh run)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        run_number: int</span>
<span class="sd">            The index of this run (should be 1-indexed!)</span>

<span class="sd">        restart_state: dict</span>
<span class="sd">            Dictionary holding the current state of the restarting procedure</span>

<span class="sd">        first_extension: bool</span>
<span class="sd">            True if this is the first run of an extension set. If True, then back up west.cfg, and write the extended</span>
<span class="sd">            west.cfg file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Linking run files from restart0/run</span><span class="si">{</span><span class="n">run_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Copy traj_segs, seg_logs, and west.h5 for restart0/runXX back into ./</span>
        <span class="c1">#       Later: (May only need to copy the latest iteration traj_segs, to avoid tons of back and forth)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s2">&quot;traj_segs&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s2">&quot;seg_logs&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Cannot call rmtree on a symbolic link&quot;</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="s2">&quot;traj_segs&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="s2">&quot;seg_logs&quot;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">we_h5filename</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;restart0/run</span><span class="si">{</span><span class="n">run_number</span><span class="si">}</span><span class="s2">/traj_segs&quot;</span><span class="p">,</span> <span class="s2">&quot;traj_segs&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;restart0/run</span><span class="si">{</span><span class="n">run_number</span><span class="si">}</span><span class="s2">/seg_logs&quot;</span><span class="p">,</span> <span class="s2">&quot;seg_logs&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">first_extension</span><span class="p">:</span>

            <span class="c1"># Get lines to make a new west.cfg by extending west.propagation.max_total_iterations</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;west.cfg&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">west_config</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">west_config</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                    <span class="c1"># Parse out the number of maximum iterations</span>
                    <span class="k">if</span> <span class="s2">&quot;max_total_iterations&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">max_iters</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span>
                        <span class="p">]</span>
                        <span class="n">new_max_iters</span> <span class="o">=</span> <span class="n">max_iters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_iters</span>
                        <span class="n">new_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">new_max_iters</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_line</span>
                        <span class="k">break</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">restart_state</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;First WE extension run ready!&quot;</span><span class="p">)</span>
        <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">===== Restart </span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;restarts_completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Run </span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;runs_completed&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> extension running =====</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># TODO: I can&#39;t just go straight into a w_run here. w_run expects some things to be set I think, that aren&#39;t.</span>
        <span class="c1">#   I can do w_init, and do a new simulation just fine...</span>
        <span class="c1">#   I can do this on ONE run repeatedly just fine</span>
        <span class="c1">#   But if I try to just copy files and continue like this, there&#39;s something screwy in state somewhere that</span>
        <span class="c1">#       causes it to fail.</span>
        <span class="c1">#   The error has to do with offsets in the HDF5 file?</span>
        <span class="c1">#   Need to figure out what state would be cleared by w_init</span>

        <span class="c1"># Frankly, this is a really sketchy way of doing this, but it seems to work...</span>
        <span class="c1">#   I remain skeptical there&#39;s not something weird under the hood that isn&#39;t being addressed correctly with</span>
        <span class="c1">#   regard to state, but if it works, it&#39;s good enough for now..</span>
        <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;restart0/run</span><span class="si">{</span><span class="n">run_number</span><span class="si">}</span><span class="s2">/west.h5&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">we_h5filename</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">open_backing</span><span class="p">()</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sim manager thought n_iter was </span><span class="si">{</span><span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">n_iter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Data manager thought current_iteration was </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">current_iteration</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_manager</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">sim_manager</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">max_total_iterations</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_iters</span>

        <span class="n">w_run</span><span class="o">.</span><span class="n">run_simulation</span><span class="p">()</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">generate_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart_directory</span><span class="p">):</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Producing flux-profile, pseudocommittor, and target flux comparison plots.&quot;</span>
        <span class="p">)</span>
        <span class="n">flux_pcoord_fig</span><span class="p">,</span> <span class="n">flux_pcoord_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">plot_flux</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">flux_pcoord_ax</span><span class="p">,</span> <span class="n">suppress_validation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">flux_pcoord_fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="s2">&quot;This flux profile should become flatter after restarting&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">flux_pcoord_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
        <span class="n">flux_pcoord_fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/flux_plot.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span>
        <span class="p">)</span>

        <span class="n">flux_pseudocomm_fig</span><span class="p">,</span> <span class="n">flux_pseudocomm_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">plot_flux_committor</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">flux_pseudocomm_ax</span><span class="p">,</span> <span class="n">suppress_validation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">flux_pseudocomm_fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="s2">&quot;This flux profile should become flatter after restarting.&quot;</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The x-axis is a &quot;pseudo&quot;committor, since it may be &#39;</span>
            <span class="s2">&quot;calculated from WE trajectories in the one-way ensemble.&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">flux_pseudocomm_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
        <span class="n">flux_pseudocomm_fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/pseudocomm-flux_plot.pdf&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span>
        <span class="p">)</span>

        <span class="n">flux_comparison_fig</span><span class="p">,</span> <span class="n">flux_comparison_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="c1"># Get haMSM flux estimates</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>
        <span class="n">models</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">validation_models</span><span class="p">)</span>
        <span class="n">n_validation_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">validation_models</span><span class="p">)</span>

        <span class="n">flux_estimates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="n">flux_estimates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_model</span><span class="o">.</span><span class="n">JtargetSS</span><span class="p">)</span>

        <span class="n">hamsm_flux_colors</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.prop_cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
        <span class="n">direct_flux_colors</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">cool</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">fileList</span><span class="p">)))</span>
        <span class="p">)</span>

        <span class="c1"># Get WE direct flux estimate</span>
        <span class="k">for</span> <span class="n">_file</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">fileList</span><span class="p">:</span>

            <span class="n">run</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">_file</span><span class="p">)</span>
            <span class="n">last_iter</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">num_iterations</span>
            <span class="n">recycled</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">iteration</span><span class="p">(</span><span class="n">last_iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">recycled_walkers</span><span class="p">)</span>
            <span class="n">target_flux</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">walker</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">walker</span> <span class="ow">in</span> <span class="n">recycled</span><span class="p">)</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">tau</span>

            <span class="c1"># TODO: Correct for time!</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_file</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">:</span>
                <span class="n">short_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;....</span><span class="si">{</span><span class="n">_file</span><span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">short_filename</span> <span class="o">=</span> <span class="n">_file</span>

            <span class="k">if</span> <span class="n">target_flux</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">flux_comparison_ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
                <span class="n">target_flux</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">direct_flux_colors</span><span class="p">),</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Last iter WE direct </span><span class="si">{</span><span class="n">target_flux</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  (</span><span class="si">{</span><span class="n">short_filename</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">flux_comparison_ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
            <span class="n">flux_estimates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Main model estimate</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">flux_estimates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">hamsm_flux_colors</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_validation_models</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">flux_comparison_ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
                <span class="n">flux_estimates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Validation model </span><span class="si">{</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> estimate</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">flux_estimates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">hamsm_flux_colors</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">flux_comparison_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
        <span class="n">flux_comparison_ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">flux_comparison_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Flux&quot;</span><span class="p">)</span>
        <span class="n">flux_comparison_ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">flux_comparison_fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">flux_comparison_fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/hamsm_vs_direct_flux_comparison_plot.pdf&quot;</span><span class="p">,</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_we</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialization_state</span><span class="p">,</span> <span class="n">pcoord_cache</span><span class="p">):</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="n">original_get_pcoord</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">pcoord_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Enabling pcoord cache for new WE run initialization&quot;</span><span class="p">)</span>
            <span class="n">propagator</span> <span class="o">=</span> <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">propagator</span>
            <span class="n">original_get_pcoord</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_pcoord</span>

            <span class="k">def</span> <span class="nf">get_cached_pcoord</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                For the cached pcoords, I&#39;ll be getting a bunch of istate/bstate/sstates, and I need to</span>
<span class="sd">                    map them to some cached pcoord values.</span>

<span class="sd">                At this point, my start states are just basis states (not initial states)... Because of that,</span>
<span class="sd">                in order to determine if it&#39;s a start state or an &quot;actual&quot; basis state, we can check if the label\</span>
<span class="sd">                matches the bX_sY format we use below.</span>

<span class="sd">                This is a little janky and fragile.</span>

<span class="sd">                This function is defined inline because it needs to take only the state argument, and have access to</span>
<span class="sd">                the cache.</span>
<span class="sd">                TODO: That could also be done by just adding those as attributes to the state.</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="c1"># If it IS a start-state, then retrieve the pcoord from the cache</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">label</span>

                <span class="n">template</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^b(\d+)_s(\d+)$&#39;</span><span class="p">)</span>
                <span class="n">is_start_state</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_start_state</span><span class="p">:</span>

                    <span class="c1"># This is NOT the &quot;segment index&quot; as WESTPA describes it -- it&#39;s the index of this structure</span>
                    <span class="c1">#   among structures in this cluster.</span>
                    <span class="n">cluster_idx</span><span class="p">,</span> <span class="n">cluster_seg_idx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="n">cluster_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cluster_idx</span><span class="p">)</span>
                    <span class="n">cluster_seg_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cluster_seg_idx</span><span class="p">)</span>

                    <span class="n">state</span><span class="o">.</span><span class="n">pcoord</span> <span class="o">=</span> <span class="n">pcoord_cache</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">cluster_idx</span><span class="p">)][</span><span class="nb">int</span><span class="p">(</span><span class="n">cluster_seg_idx</span><span class="p">)]</span>

                <span class="c1"># If it&#39;s not a start state, then apply the normal pcoord calculation</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not using cache for state </span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">original_get_pcoord</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

            <span class="n">propagator</span><span class="o">.</span><span class="n">get_pcoord</span> <span class="o">=</span> <span class="n">get_cached_pcoord</span>

        <span class="n">w_init</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
            <span class="o">**</span><span class="n">initialization_state</span><span class="p">,</span>
            <span class="n">shotgun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">pcoord_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">propagator</span><span class="o">.</span><span class="n">get_pcoord</span> <span class="o">=</span> <span class="n">original_get_pcoord</span>

        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime of w_init was </span><span class="si">{</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RestartDriver.prepare_new_we"><a class="viewcode-back" href="../../../api.html#msm_we.westpa_plugins.restart_driver.RestartDriver.prepare_new_we">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_new_we</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function prepares a new WESTPA simulation using haMSM analysis to accelerate convergence.</span>

<span class="sd">        The marathon functionality does re-implement some of the functionality of w_multi_west.</span>
<span class="sd">        However, w_multi_west merges independent WE simulations, which may or may not be desirable.</span>
<span class="sd">        I think for the purposes of this, it&#39;s good to keep the runs completely independent until haMSM model building.</span>
<span class="sd">        Either that, or I&#39;m just justifying not having known about w_multi_west when I wrote this. TBD.</span>

<span class="sd">        The algorithm is as follows:</span>

<span class="sd">            1. Check to see if we&#39;ve just completed the final iteration</span>

<span class="sd">            2. Handle launching multiple runs, if desired</span>

<span class="sd">            3. Build haMSM</span>

<span class="sd">            4. Obtain structures for each haMSM bin</span>

<span class="sd">            5. Make each structure a start-state, with probability set by (MSM-bin SS prob / # structures in bin)</span>

<span class="sd">            6. Potentially some renormalization?</span>

<span class="sd">            7. Start new WE simulation</span>

<span class="sd">        TODO</span>
<span class="sd">        ----</span>
<span class="sd">        Replace all manual path-building with pathlib</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Do nothing if it&#39;s not the final iteration</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_last_iteration</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_iter</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Final iteration, preparing restart&quot;</span><span class="p">)</span>

        <span class="n">restart_state</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;restarts_completed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;runs_completed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="c1"># Check for the existence of the extension lockfile here</span>
        <span class="n">doing_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">EXTENSION_LOCKFILE</span><span class="p">)</span>

        <span class="c1"># Look for a restart.dat file to get the current state (how many restarts have been performed already)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">restart_state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

        <span class="c1"># This is the final iteration of a run, so mark this run as completed</span>
        <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;runs_completed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Make the folder to store data for this marathon</span>
        <span class="n">restart_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;restart</span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;restarts_completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">run_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/run</span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;runs_completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">run_directory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">run_directory</span><span class="p">)</span>

        <span class="c1"># Write coordinates to h5</span>
        <span class="c1"># prepare_coordinates(self.plugin_config, self.data_manager.we_h5file, self.data_manager.we_h5filename)</span>

        <span class="k">for</span> <span class="n">data_folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;traj_segs&quot;</span><span class="p">,</span> <span class="s2">&quot;seg_logs&quot;</span><span class="p">]:</span>
            <span class="n">old_path</span> <span class="o">=</span> <span class="n">data_folder</span>

            <span class="c1"># If you&#39;re doing an extension, this will be a symlink. So no need to copy, just unlink it and move on</span>
            <span class="k">if</span> <span class="n">doing_extension</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">old_path</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unlinking symlink&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">new_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">run_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">old_path</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Moving </span><span class="si">{</span><span class="n">old_path</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_path</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_path</span><span class="si">}</span><span class="s2"> already exists. Removing and overwriting.&quot;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Folder </span><span class="si">{</span><span class="n">old_path</span><span class="si">}</span><span class="s2"> was not found.&quot;</span>
                    <span class="s2">&quot;This may be normal, but check your configuration.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Make a new data folder for the next run</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>

        <span class="n">last_run</span> <span class="o">=</span> <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;runs_completed&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span>
        <span class="n">last_restart</span> <span class="o">=</span> <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;restarts_completed&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_restarts</span>

        <span class="c1"># We&#39;ve just finished a run. Let&#39;s check if we have to do any more runs in this marathon before doing a restart.</span>
        <span class="c1">#   In the case of n_runs == 1, then we&#39;re just doing a single run and restarting it every so often.</span>
        <span class="c1">#   Otherwise, a marathon consists of multiple runs,  and restarts are performed between marathons.</span>
        <span class="k">if</span> <span class="n">last_run</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span><span class="si">}</span><span class="s2"> runs in this marathon completed.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">last_restart</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All restarts completed! Performing final analysis.&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Proceeding to prepare a restart.&quot;</span><span class="p">)</span>

                <span class="c1"># Duplicating this is  gross, but given the structure here, my options are either put it above these ifs</span>
                <span class="c1">#   entirely, meaning it&#39;ll be unnecessarily run at the end of the final restart, or duplicate it below.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing coordinates for this run.&quot;</span><span class="p">)</span>

                <span class="c1"># Now, continue on to haMSM calculation below.</span>

        <span class="c1"># If we have more runs left to do in this marathon, prepare them</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">last_run</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run </span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;runs_completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span><span class="si">}</span><span class="s2"> completed.&quot;</span><span class="p">)</span>

            <span class="c1"># TODO: Initialize a new run, from the same configuration as this run was</span>
            <span class="c1">#   On the 1st run, I can write bstates/tstates/sstates into restart files, and use those for spawning</span>
            <span class="c1">#   subsequent runs in the marathon. That way, I don&#39;t make unnecessary copies of all those.</span>
            <span class="c1"># Basis and target states are unchanged. Can I get the original parameters passed to w_init?</span>
            <span class="c1"># Ideally, I should be able to call w_init with the exact same parameters that went to it the first time</span>
            <span class="n">initialization_state</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;tstate_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;bstate_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;sstate_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;tstates&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;bstates&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;sstates&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;segs_per_state&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># TODO: Implement this, and get rid of the initialization_file usage right below. Placeholder for now.</span>
            <span class="k">if</span> <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;runs_completed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                <span class="c1"># Get and write basis, target, start states and segs per state for this marathon to disk</span>
                <span class="k">pass</span>

            <span class="c1"># Save the WESTPA h5 data from this run</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">finalize_run</span><span class="p">()</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;west.h5&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">run_directory</span><span class="si">}</span><span class="s2">/west.h5&quot;</span><span class="p">)</span>

            <span class="c1"># If this is a regular, fresh run (not an extension)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doing_extension</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialization_file</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialization_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                        <span class="n">initialization_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                        <span class="n">initialization_dict</span> <span class="o">=</span> <span class="n">fix_deprecated_initialization</span><span class="p">(</span>
                            <span class="n">initialization_dict</span>
                        <span class="p">)</span>
                        <span class="n">initialization_state</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">initialization_dict</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;No initialization JSON file provided -- &quot;</span>
                        <span class="s2">&quot;I don&#39;t know how to start new runs in this marathon.&quot;</span>
                    <span class="p">)</span>

                <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">===== Restart </span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;restarts_completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Run </span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;runs_completed&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> initializing =====</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span><span class="n">initialization_state</span><span class="p">)</span>

                <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run: </span><span class="se">\n\t</span><span class="s2"> w_init --tstate-file </span><span class="si">{</span><span class="n">initialization_state</span><span class="p">[</span><span class="s1">&#39;tstate_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;--bstate-file </span><span class="si">{</span><span class="n">initialization_state</span><span class="p">[</span><span class="s1">&#39;bstate_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;--sstate-file </span><span class="si">{</span><span class="n">initialization_state</span><span class="p">[</span><span class="s1">&#39;sstate_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;--segs-per-state </span><span class="si">{</span><span class="n">initialization_state</span><span class="p">[</span><span class="s1">&#39;segs_per_state&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">init_we</span><span class="p">(</span><span class="n">initialization_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoord_cache</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">restart_state</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New WE run ready!&quot;</span><span class="p">)</span>
                <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">===== Restart </span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;restarts_completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Run </span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;runs_completed&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> running =====</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">w_run</span><span class="o">.</span><span class="n">run_simulation</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># If we&#39;re doing an extension set</span>
            <span class="c1">#   Instead of w_initting a new iteration, copy the files from restart0/runXX back into ./</span>
            <span class="k">elif</span> <span class="n">doing_extension</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">prepare_extension_run</span><span class="p">(</span>
                    <span class="n">run_number</span><span class="o">=</span><span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;runs_completed&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">restart_state</span><span class="o">=</span><span class="n">restart_state</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;restarts_completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_restarts</span><span class="si">}</span><span class="s2"> restarts completed&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Build the haMSM</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing haMSM&quot;</span><span class="p">)</span>

        <span class="c1"># Need to write the h5 file and close it out, but I need to get the current bstates first.</span>
        <span class="n">original_bstates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">current_iter_bstates</span>
        <span class="k">if</span> <span class="n">original_bstates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">original_bstates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">get_basis_states</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>

        <span class="k">assert</span> <span class="n">original_bstates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Bstates are none in the current iteration&quot;</span>

        <span class="n">original_tstates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">get_target_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_iter</span><span class="p">)</span>

        <span class="c1"># Flush h5 file writes and copy it to the run directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">finalize_run</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">we_h5filename</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">run_directory</span><span class="si">}</span><span class="s2">/west.h5&quot;</span><span class="p">)</span>

        <span class="c1"># Use all files in all restarts</span>
        <span class="c1"># Restarts index at 0, because there&#39;s  a 0th restart before you&#39;ve... restarted anything.</span>
        <span class="c1"># Runs index at 1, because Run 1 is the first run.</span>
        <span class="c1"># TODO: Let the user pick last half or something in the plugin config.</span>
        <span class="n">marathon_west_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># When doing the first restart, restarts_completed is 0 (because the first restart isn&#39;t complete yet) and</span>
        <span class="c1">#   the data generated during this restart is in /restart0.</span>
        <span class="c1"># So when doing the Nth restart, restarts_completed is N-1</span>

        <span class="c1"># If set to -1, use all restarts</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restarts_to_use</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">last_N_restarts</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;restarts_completed&quot;</span><span class="p">]</span>
        <span class="c1"># If this is an integer, use the last N restarts</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">restarts_to_use</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">last_N_restarts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restarts_to_use</span>
        <span class="c1"># If it&#39;s a decimal between 0 and 1, use it as a fraction</span>
        <span class="c1"># At restart 1, and a fraction of 0.5, this should just use restart 1</span>
        <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">restarts_to_use</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">last_N_restarts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restarts_to_use</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;restarts_completed&quot;</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="c1"># If this fraction is &lt;1, use all until it&#39;s not</span>
            <span class="k">if</span> <span class="n">last_N_restarts</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">last_N_restarts</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;restarts_completed&quot;</span><span class="p">]</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Last N is </span><span class="si">{</span><span class="n">last_N_restarts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">first_restart</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">1</span> <span class="o">+</span> <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;restarts_completed&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">last_N_restarts</span><span class="p">,</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">usable_restarts</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_restart</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;restarts_completed&quot;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;At restart </span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;restarts_completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, building haMSM using data from restarts </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">usable_restarts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">restart_number</span> <span class="ow">in</span> <span class="n">usable_restarts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">run_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;runs_completed&quot;</span><span class="p">]):</span>

                <span class="n">west_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;restart</span><span class="si">{</span><span class="n">restart_number</span><span class="si">}</span><span class="s2">/run</span><span class="si">{</span><span class="n">run_number</span><span class="si">}</span><span class="s2">/west.h5&quot;</span>
                <span class="n">marathon_west_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">west_file_path</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WESTPA datafile for analysis are </span><span class="si">{</span><span class="n">marathon_west_files</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># If this is the first restart, check to see if you got any target state flux</span>
        <span class="k">if</span> <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;restarts_completed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">pass</span>

            <span class="c1"># Check to see if you got any target flux in ANY runs</span>
            <span class="n">target_reached</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">west_file_path</span> <span class="ow">in</span> <span class="n">marathon_west_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">check_target_reached</span><span class="p">(</span><span class="n">west_file_path</span><span class="p">):</span>
                    <span class="n">target_reached</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="c1"># If you reached the target, clean up from the extensions and then continue as normal</span>
            <span class="c1"># If  extension_iters is set to 0, then don&#39;t do extensions.</span>
            <span class="k">if</span> <span class="n">target_reached</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_iters</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All runs reached target!&quot;</span><span class="p">)</span>

                <span class="c1"># Do some cleanup from the extension run</span>
                <span class="k">if</span> <span class="n">doing_extension</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_iters</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="c1"># Remove the doing_extensions.lck lockfile</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">EXTENSION_LOCKFILE</span><span class="p">)</span>

                    <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">sim_manager</span><span class="o">.</span><span class="n">max_total_iterations</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">base_total_iterations</span>
                    <span class="p">)</span>

                <span class="c1"># Otherwise, just continue as normal</span>
                <span class="k">pass</span>

            <span class="c1"># If no runs reached the target, then we need to extend them</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">target_reached</span><span class="p">:</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Target not reached. Preparing for extensions.&quot;</span><span class="p">)</span>

                <span class="c1"># Create the doing_extensions.lck &quot;lockfile&quot; to indicate we&#39;re in extend mode (or keep if exists)</span>
                <span class="c1">#   and write the initial number of iterations to it.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">EXTENSION_LOCKFILE</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">EXTENSION_LOCKFILE</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lockfile</span><span class="p">:</span>
                        <span class="n">lockfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_total_iterations</span><span class="p">))</span>

                <span class="c1"># Reset runs_completed to 0, and rewrite restart.dat accordingly</span>
                <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;runs_completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">prepare_extension_run</span><span class="p">(</span>
                    <span class="n">run_number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">restart_state</span><span class="o">=</span><span class="n">restart_state</span><span class="p">,</span> <span class="n">first_extension</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Building haMSM and computing steady-state&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cur iter is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_iter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5file_paths</span> <span class="o">=</span> <span class="n">marathon_west_files</span>

        <span class="c1"># Wipe out the old pcoord cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pcoord_cache</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_hamsm</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting built haMSM from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ss_dist, ss_flux, model = msmwe_compute_ss(self.plugin_config, marathon_west_files)</span>
        <span class="n">ss_dist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pSS</span>
        <span class="n">ss_flux</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">JtargetSS</span>
        <span class="c1"># model = self.data_manager.model</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Steady-state distribution: </span><span class="si">{</span><span class="n">ss_dist</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target steady-state flux is </span><span class="si">{</span><span class="n">ss_flux</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Obtain cluster-structures</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Obtaining cluster-structures&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">update_cluster_structures</span><span class="p">(</span><span class="n">build_pcoord_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_pcoords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pcoord_cache</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pcoord_cache</span><span class="p">)</span>

        <span class="c1"># TODO: Do this with pathlib</span>
        <span class="n">struct_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/structs&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">struct_directory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">struct_directory</span><span class="p">)</span>

        <span class="n">flux_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/JtargetSS.txt&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">flux_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing flux to </span><span class="si">{</span><span class="n">flux_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">JtargetSS</span><span class="p">))</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">ss_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/pSS.txt&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ss_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing pSS to </span><span class="si">{</span><span class="n">ss_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">pSS</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># If this is the last run of the last restart, do nothing and exit.</span>
        <span class="c1"># if restart_state[&#39;runs_completed&#39;] &gt;= self.n_runs and restart_state[&#39;restarts_completed&#39;] &gt;= self.n_restarts:</span>
        <span class="c1">#     log.info(&quot;All restarts completed!&quot;)</span>
        <span class="c1">#     return</span>

        <span class="c1"># Construct start-state file with all structures and their weights</span>
        <span class="c1"># TODO: Don&#39;t explicitly write EVERY structure to disk, or this will be a nightmare for large runs.</span>
        <span class="c1"># However, for now, it&#39;s fine...</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Writing structures&quot;</span><span class="p">)</span>
        <span class="c1"># TODO: Include start states from previous runs</span>
        <span class="n">sstates_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/startstates.txt&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sstates_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>

            <span class="c1"># Track the total number of segments iterated over</span>
            <span class="n">seg_idx</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Obtaining potential start structures (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cluster_structures</span><span class="o">.</span><span class="n">items</span><span class="p">())</span><span class="si">}</span><span class="s2"> bins avail)&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Can use these for sanity checks</span>
            <span class="n">total_weight</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">total_bin_weights</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Loop over each set of (bin index, all the structures in that bin)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">msm_bin_idx</span><span class="p">,</span> <span class="n">structures</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">cluster_structures</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">):</span>

                <span class="n">total_bin_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Don&#39;t put structures in the basis or target</span>
                <span class="k">if</span> <span class="n">msm_bin_idx</span> <span class="ow">in</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">n_clusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="c1"># The per-segment bin probability.</span>
                <span class="c1"># Map a cluster number onto a cluster INDEX, because after cleaning the cluster numbers may no longer</span>
                <span class="c1"># be consecutive.</span>
                <span class="n">bin_prob</span> <span class="o">=</span> <span class="n">ss_dist</span><span class="p">[</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">cluster_mapping</span><span class="p">[</span><span class="n">msm_bin_idx</span><span class="p">]</span>
                <span class="p">]</span>  <span class="c1"># / len(structures)</span>

                <span class="k">if</span> <span class="n">bin_prob</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;MSM-Bin </span><span class="si">{</span><span class="n">msm_bin_idx</span><span class="si">}</span><span class="s2">  has probability 0, so not saving any structs from it.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># The total amount of WE weight in this MSM microbin</span>
                <span class="n">msm_bin_we_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">cluster_structure_weights</span><span class="p">[</span><span class="n">msm_bin_idx</span><span class="p">])</span>

                <span class="c1"># Write each structure to disk. Loop over each structure within a bin.</span>
                <span class="n">msm_bin_we_weight_tracker</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synd_full_coord_map_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">hashlib</span>

                    <span class="c1"># Here, we have a bunch of structures that, if we&#39;re using SynD, we need to be able to map back to</span>
                    <span class="c1">#   discrete states.</span>
                    <span class="c1"># Maybe that&#39;s another feature to add to SynD, but in the meantime, we can do the following...</span>
                    <span class="c1"># We can&#39;t make a dictionary mapping structures to discrete states, because lists and arrays aren&#39;t</span>
                    <span class="c1">#   hashable. But, we can explicitly hash the structures, then use that.</span>
                    <span class="c1"># There&#39;s probably a better way of uniquely representing structures, but this will do for now.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reverse_coord_map</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">():</span> <span class="n">k</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synd_full_coord_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>

                <span class="k">for</span> <span class="n">struct_idx</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">structures</span><span class="p">):</span>

                    <span class="c1"># One structure per segment</span>
                    <span class="n">seg_we_weight</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">cluster_structure_weights</span><span class="p">[</span><span class="n">msm_bin_idx</span><span class="p">][</span>
                        <span class="n">struct_idx</span>
                    <span class="p">]</span>
                    <span class="n">msm_bin_we_weight_tracker</span> <span class="o">+=</span> <span class="n">seg_we_weight</span>

                    <span class="c1"># Structure weights are set according to Algorithm 5.3 in</span>
                    <span class="c1"># Aristoff, D. &amp; Zuckerman, D. M. Optimizing Weighted Ensemble Sampling of Steady States.</span>
                    <span class="c1"># Multiscale Model Sim 18, 646–673 (2020).</span>
                    <span class="n">structure_weight</span> <span class="o">=</span> <span class="n">seg_we_weight</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_prob</span> <span class="o">/</span> <span class="n">msm_bin_we_weight</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synd_full_coord_map_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># If we&#39;re using SynD, the basis state isn&#39;t a structure but a discrete index.</span>

                        <span class="n">structure_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_coord_map</span><span class="p">[</span>
                            <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                        <span class="p">]</span>
                        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;b</span><span class="si">{</span><span class="n">msm_bin_idx</span><span class="si">}</span><span class="s2">_s</span><span class="si">{</span><span class="n">struct_idx</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">structure_weight</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">structure_index</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">seg_idx</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="n">structure_filename</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">struct_directory</span><span class="si">}</span><span class="s2">/bin</span><span class="si">{</span><span class="n">msm_bin_idx</span><span class="si">}</span><span class="s2">_&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;struct</span><span class="si">{</span><span class="n">struct_idx</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">STRUCT_EXTENSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">struct_filetype</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                        <span class="n">total_bin_weights</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">structure_weight</span>
                        <span class="n">total_weight</span> <span class="o">+=</span> <span class="n">structure_weight</span>

                        <span class="n">topology</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reference_structure</span><span class="o">.</span><span class="n">topology</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">angles</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reference_structure</span><span class="o">.</span><span class="n">unitcell_angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">lengths</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reference_structure</span><span class="o">.</span><span class="n">unitcell_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
                        <span class="c1"># This throws typeerror if reference_structure.unitcell_angles is None, or AttributeError</span>
                        <span class="c1">#   if reference_structure.unitcell_angles doesn&#39;t exist.</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                            <span class="n">angles</span><span class="p">,</span> <span class="n">lengths</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

                        <span class="n">coords</span> <span class="o">=</span> <span class="n">structure</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># Correct units</span>

                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_filetype</span><span class="p">(</span>
                            <span class="n">structure_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span>
                        <span class="p">)</span> <span class="k">as</span> <span class="n">struct_file</span><span class="p">:</span>

                            <span class="c1"># Write the structure file</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_filetype</span> <span class="ow">is</span> <span class="n">md</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">PDBTrajectoryFile</span><span class="p">:</span>
                                <span class="n">struct_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                    <span class="n">coords</span><span class="p">,</span>
                                    <span class="n">topology</span><span class="p">,</span>
                                    <span class="n">modelIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">unitcell_angles</span><span class="o">=</span><span class="n">angles</span><span class="p">,</span>
                                    <span class="n">unitcell_lengths</span><span class="o">=</span><span class="n">lengths</span><span class="p">,</span>
                                <span class="p">)</span>

                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_filetype</span> <span class="ow">is</span> <span class="n">md</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">AmberRestartFile</span><span class="p">:</span>
                                <span class="c1"># AmberRestartFile takes slightly differently named keyword args</span>
                                <span class="n">struct_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                    <span class="n">coords</span><span class="p">,</span>
                                    <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">cell_angles</span><span class="o">=</span><span class="n">angles</span><span class="p">,</span>
                                    <span class="n">cell_lengths</span><span class="o">=</span><span class="n">lengths</span><span class="p">,</span>
                                <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Otherwise, YOLO just hope all the positional arguments are in the right place</span>
                                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;This output filetype (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">struct_filetype</span><span class="si">}</span><span class="s2">) is probably supported, &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;but not explicitly handled.&quot;</span>
                                    <span class="s2">&quot; You should ensure that it takes argument as (coords, topology)&quot;</span>
                                <span class="p">)</span>
                                <span class="n">struct_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">topology</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                                    <span class="s2">&quot;Don&#39;t know what extension to use for this filetype&quot;</span>
                                <span class="p">)</span>

                        <span class="c1"># Add this start-state to the start-states file</span>
                        <span class="c1"># This path is relative to WEST_SIM_ROOT</span>
                        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;b</span><span class="si">{</span><span class="n">msm_bin_idx</span><span class="si">}</span><span class="s2">_s</span><span class="si">{</span><span class="n">struct_idx</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">structure_weight</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">structure_filename</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">seg_idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># log.info(f&quot;WE weight ({msm_bin_we_weight_tracker:.5e} / {msm_bin_we_weight:.5e})&quot;)</span>

            <span class="c1"># TODO: Fix this check. It&#39;s never quite worked right, nor has it ever caught an actual problem, so just</span>
            <span class="c1">#   disable for now.</span>
            <span class="c1"># In equilibrium, all probabilities count, but in steady-state the last 2 are the target/basis</span>
            <span class="c1"># Subtract off the probabilities of the basis and target states, since those don&#39;t have structures</span>
            <span class="c1">#   assigned to them.</span>
            <span class="c1"># assert np.isclose(total_weight, 1 - sum(model.pSS[model.n_clusters :])), (</span>
            <span class="c1">#     f&quot;Total steady-state structure weights not normalized! (Total: {total_weight}) &quot;</span>
            <span class="c1">#     f&quot;\n\t pSS: {model.pSS}&quot;</span>
            <span class="c1">#     f&quot;\n\t Total bin weights {total_bin_weights}&quot;</span>
            <span class="c1">#     f&quot;\n\t pSS sum: {sum(model.pSS)}&quot;</span>
            <span class="c1">#     f&quot;\n\t pSS -2 sum: {sum(model.pSS[:-2])}&quot;</span>
            <span class="c1">#     f&quot;\n\t pSS (+target, no basis) sum: {sum(model.pSS[:-2]) + model.pSS[-1]}&quot;</span>
            <span class="c1"># )</span>

        <span class="c1"># ## Start the new simulation</span>

        <span class="n">bstates_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">original_bstate</span> <span class="ow">in</span> <span class="n">original_bstates</span><span class="p">:</span>
            <span class="n">orig_bstate_prob</span> <span class="o">=</span> <span class="n">original_bstate</span><span class="o">.</span><span class="n">probability</span>
            <span class="n">orig_bstate_label</span> <span class="o">=</span> <span class="n">original_bstate</span><span class="o">.</span><span class="n">label</span>
            <span class="n">orig_bstate_aux</span> <span class="o">=</span> <span class="n">original_bstate</span><span class="o">.</span><span class="n">auxref</span>

            <span class="n">bstate_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">orig_bstate_label</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">orig_bstate_prob</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">orig_bstate_aux</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">bstates_str</span> <span class="o">+=</span> <span class="n">bstate_str</span>

        <span class="n">bstates_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/basisstates.txt&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bstates_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bstates_str</span><span class="p">)</span>

        <span class="n">tstates_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">original_tstate</span> <span class="ow">in</span> <span class="n">original_tstates</span><span class="p">:</span>
            <span class="n">orig_tstate_label</span> <span class="o">=</span> <span class="n">original_tstate</span><span class="o">.</span><span class="n">label</span>
            <span class="c1"># TODO: Handle multidimensional pcoords</span>
            <span class="n">orig_tstate_pcoord</span> <span class="o">=</span> <span class="n">original_tstate</span><span class="o">.</span><span class="n">pcoord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">tstate_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">orig_tstate_label</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">orig_tstate_pcoord</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">tstates_str</span> <span class="o">+=</span> <span class="n">tstate_str</span>
        <span class="n">tstates_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/targetstates.txt&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tstates_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tstates_str</span><span class="p">)</span>

        <span class="c1"># Pickle the model</span>
        <span class="n">objFile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/hamsm.obj&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">objFile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">objFileHandler</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pickling model&quot;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">objFileHandler</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">objFileHandler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Before finishing this restart, make a plot of the flux profile.</span>
        <span class="c1">#   This is made so the user can see whether</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generate_plots</span><span class="p">(</span><span class="n">restart_directory</span><span class="p">)</span>

        <span class="c1"># At this point, the restart is completed, and the data for the next one is ready (though still need to make the</span>
        <span class="c1">#   initialization file and such).</span>

        <span class="k">if</span> <span class="n">last_restart</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All restarts completed! Finished.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Update restart_file file</span>
        <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;restarts_completed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># If we&#39;re doing a restart, then reset the number of completed runs to 0 for the next marathon.</span>
        <span class="n">restart_state</span><span class="p">[</span><span class="s2">&quot;runs_completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">restart_state</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing new run&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: Read this from config if available</span>
        <span class="n">segs_per_state</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">old_initialization_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialization_file</span>
        <span class="n">new_initialization_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">restart_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">initialization_file</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Moving initialization file from </span><span class="si">{</span><span class="n">old_initialization_path</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_initialization_path</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">old_initialization_path</span><span class="p">,</span> <span class="n">new_initialization_path</span><span class="p">)</span>

        <span class="n">initialization_state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tstate_file&quot;</span><span class="p">:</span> <span class="n">tstates_filename</span><span class="p">,</span>
            <span class="s2">&quot;bstate_file&quot;</span><span class="p">:</span> <span class="n">bstates_filename</span><span class="p">,</span>
            <span class="s2">&quot;sstate_file&quot;</span><span class="p">:</span> <span class="n">sstates_filename</span><span class="p">,</span>
            <span class="s2">&quot;tstates&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;bstates&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;sstates&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;segs_per_state&quot;</span><span class="p">:</span> <span class="n">segs_per_state</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialization_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">initialization_state</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>


        <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;===== Restart </span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;restarts_completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Run </span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;runs_completed&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> initializing =====</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run: </span><span class="se">\n\t</span><span class="s2"> w_init --tstate-file </span><span class="si">{</span><span class="n">tstates_filename</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;--bstate-file </span><span class="si">{</span><span class="n">bstates_filename</span><span class="si">}</span><span class="s2"> --sstate-file </span><span class="si">{</span><span class="n">sstates_filename</span><span class="si">}</span><span class="s2"> --segs-per-state </span><span class="si">{</span><span class="n">segs_per_state</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calling init_we with model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_we</span><span class="p">(</span><span class="n">initialization_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcoord_cache</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New WE run ready!&quot;</span><span class="p">)</span>
        <span class="n">westpa</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">pstatus</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">===== Restart </span><span class="si">{</span><span class="n">restart_state</span><span class="p">[</span><span class="s1">&#39;restarts_completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> running =====</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">w_run</span><span class="o">.</span><span class="n">run_simulation</span><span class="p">()</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, John Russo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>